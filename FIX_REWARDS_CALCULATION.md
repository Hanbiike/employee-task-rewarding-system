# Исправление логики расчета премий

## Проблема

Ранее для квартальных и годовых премий KPI рассчитывался только за один месяц (месяц выплаты премии), но при этом данные аккумулировались как за весь период. Это приводило к некорректным значениям:

- **Квартальная премия** за сентябрь (09.2025) считала задачи за весь квартал (июль-сентябрь) как будто это 1 месяц
- В результате KPI получался завышенным в 3 раза
- Премии менеджеров также были завышены, т.к. базировались на неверных данных сотрудников

## Решение

### Изменения в расчете периодов

Теперь система корректно учитывает тип периода при расчете KPI:

1. **Месячная премия (`monthly`)**: 
   - Считаются задачи за 1 месяц
   - Пример: для периода 2025-09 считаются задачи с 2025-09-01 по 2025-09-30

2. **Квартальная премия (`quarterly`)**:
   - Считаются задачи за весь квартал (3 месяца)
   - Пример: для периода 2025-09 (3-й квартал) считаются задачи с 2025-07-01 по 2025-09-30
   - Кварталы: Q1 (янв-мар), Q2 (апр-июн), Q3 (июл-сен), Q4 (окт-дек)

3. **Годовая премия (`yearly`)**:
   - Считаются задачи за весь год (12 месяцев)
   - Пример: для периода 2025-12 считаются задачи с 2025-01-01 по 2025-12-31

### Изменения в коде

#### 1. `classes/Task.php`
- `getTasksKPIData($employeeId, $period, $periodType = 'monthly')` - добавлен параметр `$periodType`
- Функция теперь определяет правильный диапазон дат в зависимости от типа периода
- `calculateTasksKPIPercentage($employeeId, $period, $periodType = 'monthly')` - также принимает `$periodType`

#### 2. `classes/KPI.php`
- `calculateTotalKPI($employeeId, $period, $periodType = 'monthly')` - добавлен параметр `$periodType`
- Передает `$periodType` в `calculateTasksKPIPercentage()`
- `getKPIBreakdown($employeeId, $period, $periodType = 'monthly')` - также обновлен

#### 3. `classes/Reward.php`
- `calculateAndSave()` теперь передает `$periodType` в `calculateTotalKPI()`

### Формула расчета премии (не изменилась)

```
Премия = Базовая_зарплата × (KPI_total / 100)
Итого = Базовая_зарплата + Премия
```

**Важно:** Премия НЕ умножается на количество месяцев в периоде!
- Квартальная премия = одна премия за квартал (не × 3)
- Годовая премия = одна премия за год (не × 12)

Просто KPI считается за соответствующий временной диапазон.

### Формула премии менеджера (не изменилась)

```
Премия_менеджера = (100 / Количество_сотрудников) × Коэффициент × Общая_сумма_премий_сотрудников
```

Где:
- `Коэффициент` берется из настроек KPI (`manager_bonus_percentage` / 100)
- По умолчанию коэффициент = 1.0 (100%)

## Как пересчитать существующие вознаграждения

1. Откройте в браузере: `http://localhost/employee-rewarding-system/recalculate_rewards.php`
2. Скрипт автоматически пересчитает все существующие записи вознаграждений
3. Проверьте результаты в таблице

## Пример расчета

### До исправления (НЕПРАВИЛЬНО)
**Квартальная премия за Q3 2025 (период 09.2025):**
- Задачи считались за 3 месяца (июль-сентябрь)
- Но воспринимались как за 1 месяц
- KPI = 500% (вместо нормальных 100-150%)
- Премия = 150,000 × 5.0 = 750,000 руб (слишком много!)

### После исправления (ПРАВИЛЬНО)
**Квартальная премия за Q3 2025 (период 09.2025):**
- Задачи считаются за 3 месяца (июль-сентябрь) корректно
- KPI = 120% (нормальное значение)
- Премия = 150,000 × 1.2 = 180,000 руб (правильно!)

## Проверка

После пересчета проверьте:

1. **Вознаграждения сотрудников:**
   - Месячные премии не должны измениться
   - Квартальные и годовые должны стать значительно меньше

2. **Вознаграждения менеджеров:**
   - Автоматически пересчитаются на основе новых премий сотрудников
   - Также должны уменьшиться для квартальных и годовых периодов

3. **KPI в истории:**
   - Проверьте страницу "Мои KPI" для сотрудника
   - Значения KPI для квартальных/годовых периодов должны быть адекватными (0-150%)
